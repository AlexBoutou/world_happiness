<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>world map</title>
    <style>
    </style>
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>


    const margin = {top: 0, right: 0, bottom: 0, left: 20},
        width = 900 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;



    let svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append('g')
        .attr('class', 'map');

    let projection = d3.geoMercator()
        .scale(130)
        .translate([width / 2, height / 1.5]);

    let path = d3.geoPath().projection(projection);

    let color = d3.scaleSequential(d3.interpolateGreens)
    queue()
        .defer(d3.json, "../data/world_countries.json")
        .defer(d3.csv, "../data/2015.csv")
        .await(world_map);

    function world_map(error, data, population) {
        let maxScore = 0;
        let minScore = 10;

        let populationById = {};

        population.forEach(function (d) {
            populationById[d["Country"]] = +d["Happiness Score"];
        });
        data.features.forEach(function (d) {
            if (d.properties.name > maxScore) {
                maxScore = d.properties.name;
            }
            if (d.properties.name < minScore) {
                minScore = d.properties.name;
            }
            d["Happiness Score"] = populationById[d.properties.name]
        });

        svg.append("g")
            .attr("class", "countries")
            .selectAll("path")
            .data(data.features)
            .enter().append("path")
            .attr("d", path)
            .style("fill", function (d) {
                return color((d["Happiness Score"] - minScore)/(maxScore - minScore))
            })
            .style('stroke', 'white')
            .style('stroke-width', 1.5)
            .style("opacity", 0.8)
            // tooltips
            .style("stroke", "white")
            .style('stroke-width', 0.3);


        svg.append("path")
            .datum(topojson.mesh(data.features, function (a, b) {
                return a.id !== b.id;
            }))
            // .datum(topojson.mesh(data.features, function(a, b) { return a !== b; }))
            .attr("class", "names")
            .attr("d", path);
    }


</script>
</body>
</html>